/*! asmsimulator 27-01-2025 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,d=3,e=7,f=/^[-+]?[0-9]+$/,g=/^[.A-Za-z]\w*$/,h=[],i={},j={},k={},l=b.split("\n"),m=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(f.exec(a))return parseInt(a,10);throw"Invalid number format"},n=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"D"===a?3:"SP"===a?4:void 0},o=function(a){a=a.toUpperCase();var b=0,c=0;if("A"===a[0])c=0;else if("B"===a[0])c=1;else if("C"===a[0])c=2;else if("D"===a[0])c=3;else{if("SP"!==a.slice(0,2))return void 0;c=4}var d=1;if(4===c&&(d=2),"-"===a[d])b=-1;else{if("+"!==a[d])return void 0;b=1}var e=b*parseInt(a.slice(d+1),10);if(-16>e||e>15)throw"offset must be a value between -16...+15";return 0>e&&(e=32+e),8*e+c},p=function(a,b,c){var d=n(a);if(void 0!==d)return{type:b,value:d};var e=q(a);if(void 0!==e)return{type:c,value:e};if("regaddress"===b&&(d=o(a),void 0!==d))return{type:b,value:d};var f=m(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>255)throw c+" must have a value between 0-255";return{type:c,value:f}},q=function(a){return g.exec(a)?a:void 0},r=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return p(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return p(a,"register","number")}},s=(function(a){var b=a.toUpperCase();if(b in k)throw"Duplicate label: "+a;if("A"===b||"B"===b||"C"===b||"D"===b)throw"Label contains keyword: "+b;j[a]=h.length}),t=function(a,b){if(void 0!==b)throw a+": too many arguments"},u=0,v=l.length;v>u;u++)try{var w=c.exec(l[u]);if(void 0!==w[1]||void 0!==w[2]){if(void 0!==w[1]&&s(w[1]),void 0!==w[2]){var x,y,z,A=w[2].toUpperCase();switch("DB"!==A&&(i[h.length]=u),A){case"DB":if(x=r(w[d]),"number"===x.type)h.push(x.value);else{if("numbers"!==x.type)throw"DB does not support this operand";for(var B=0,C=x.value.length;C>B;B++)h.push(x.value[B])}break;case"NOP":t("NOP",w[d]),z=a.NOP,h.push(z);break;case"HLT":case"HALT":t("HALT",w[d]),z=a.HALT,h.push(z);break;case"LD":case"MOV":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.MOV_REG_TO_REG;else if("register"===x.type&&"address"===y.type)z=a.MOV_ADDRESS_TO_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.MOV_REGADDRESS_TO_REG;else if("address"===x.type&&"register"===y.type)z=a.MOV_REG_TO_ADDRESS;else if("regaddress"===x.type&&"register"===y.type)z=a.MOV_REG_TO_REGADDRESS;else if("register"===x.type&&"number"===y.type)z=a.MOV_NUMBER_TO_REG;else if("address"===x.type&&"number"===y.type)z=a.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==x.type||"number"!==y.type)throw"MOV does not support this operands";z=a.MOV_NUMBER_TO_REGADDRESS}h.push(z,x.value,y.value);break;case"ADD":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.ADD_REG_TO_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.ADD_REGADDRESS_TO_REG;else if("register"===x.type&&"address"===y.type)z=a.ADD_ADDRESS_TO_REG;else{if("register"!==x.type||"number"!==y.type)throw"ADD does not support this operands";z=a.ADD_NUMBER_TO_REG}h.push(z,x.value,y.value);break;case"SUB":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.SUB_REG_FROM_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.SUB_REGADDRESS_FROM_REG;else if("register"===x.type&&"address"===y.type)z=a.SUB_ADDRESS_FROM_REG;else{if("register"!==x.type||"number"!==y.type)throw"SUB does not support this operands";z=a.SUB_NUMBER_FROM_REG}h.push(z,x.value,y.value);break;case"INC":if(x=r(w[d]),t("INC",w[e]),"register"!==x.type)throw"INC does not support this operand";z=a.INC_REG,h.push(z,x.value);break;case"DEC":if(x=r(w[d]),t("DEC",w[e]),"register"!==x.type)throw"DEC does not support this operand";z=a.DEC_REG,h.push(z,x.value);break;case"CMP":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.CMP_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.CMP_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.CMP_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw"CMP does not support this operands";z=a.CMP_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"JMP":if(x=r(w[d]),t("JMP",w[e]),"register"===x.type)z=a.JMP_REGADDRESS;else{if("number"!==x.type)throw"JMP does not support this operands";z=a.JMP_ADDRESS}h.push(z,x.value);break;case"JC":case"JB":case"JNAE":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.JC_REGADDRESS;else{if("number"!==x.type)throw A+" does not support this operand";z=a.JC_ADDRESS}h.push(z,x.value);break;case"JNC":case"JNB":case"JAE":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.JNC_REGADDRESS;else{if("number"!==x.type)throw A+"does not support this operand";z=a.JNC_ADDRESS}h.push(z,x.value);break;case"JZ":case"JE":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.JZ_REGADDRESS;else{if("number"!==x.type)throw A+" does not support this operand";z=a.JZ_ADDRESS}h.push(z,x.value);break;case"JNZ":case"JNE":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.JNZ_REGADDRESS;else{if("number"!==x.type)throw A+" does not support this operand";z=a.JNZ_ADDRESS}h.push(z,x.value);break;case"JA":case"JNBE":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.JA_REGADDRESS;else{if("number"!==x.type)throw A+" does not support this operand";z=a.JA_ADDRESS}h.push(z,x.value);break;case"JNA":case"JBE":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.JNA_REGADDRESS;else{if("number"!==x.type)throw A+" does not support this operand";z=a.JNA_ADDRESS}h.push(z,x.value);break;case"PUSH":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.PUSH_REG;else if("regaddress"===x.type)z=a.PUSH_REGADDRESS;else if("address"===x.type)z=a.PUSH_ADDRESS;else{if("number"!==x.type)throw"PUSH does not support this operand";z=a.PUSH_NUMBER}h.push(z,x.value);break;case"POP":if(x=r(w[d]),t(A,w[e]),"register"!==x.type)throw"PUSH does not support this operand";z=a.POP_REG,h.push(z,x.value);break;case"CALL":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.CALL_REGADDRESS;else{if("number"!==x.type)throw"CALL does not support this operand";z=a.CALL_ADDRESS}h.push(z,x.value);break;case"RET":t(A,w[d]),z=a.RET,h.push(z);break;case"MUL":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.MUL_REG;else if("regaddress"===x.type)z=a.MUL_REGADDRESS;else if("address"===x.type)z=a.MUL_ADDRESS;else{if("number"!==x.type)throw"MULL does not support this operand";z=a.MUL_NUMBER}h.push(z,x.value);break;case"DIV":if(x=r(w[d]),t(A,w[e]),"register"===x.type)z=a.DIV_REG;else if("regaddress"===x.type)z=a.DIV_REGADDRESS;else if("address"===x.type)z=a.DIV_ADDRESS;else{if("number"!==x.type)throw"DIV does not support this operand";z=a.DIV_NUMBER}h.push(z,x.value);break;case"AND":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.AND_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.AND_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.AND_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw"AND does not support this operands";z=a.AND_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"OR":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.OR_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.OR_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.OR_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw"OR does not support this operands";z=a.OR_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"XOR":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.XOR_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.XOR_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.XOR_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw"XOR does not support this operands";z=a.XOR_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"NOT":if(x=r(w[d]),t(A,w[e]),"register"!==x.type)throw"NOT does not support this operand";z=a.NOT_REG,h.push(z,x.value);break;case"SHL":case"SAL":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.SHL_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.SHL_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.SHL_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw A+" does not support this operands";z=a.SHL_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"SHR":case"SAR":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.SHR_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.SHR_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.SHR_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw A+" does not support this operands";z=a.SHR_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"ROL":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.ROL_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.ROL_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.ROL_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw A+" does not support this operands";z=a.ROL_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"ROR":if(x=r(w[d]),y=r(w[e]),"register"===x.type&&"register"===y.type)z=a.ROR_REG_WITH_REG;else if("register"===x.type&&"regaddress"===y.type)z=a.ROR_REGADDRESS_WITH_REG;else if("register"===x.type&&"address"===y.type)z=a.ROR_ADDRESS_WITH_REG;else{if("register"!==x.type||"number"!==y.type)throw A+" does not support this operands";z=a.ROR_NUMBER_WITH_REG}h.push(z,x.value,y.value);break;case"RND":if(x=r(w[d]),t("RND",w[e]),"register"!==x.type)throw"RND does not support this operand";z=a.RND_REG,h.push(z,x.value);break;case"IN":if(x=r(w[d]),y=r(w[e]),"register"!==x.type||"address"!=y.type)throw A+" does not support this operands";z=a.IN_REG_PORT,h.push(z,x.value,y.value);break;case"OUT":if(x=r(w[d]),y=r(w[e]),"address"===x.type&&"register"==y.type)z=a.OUT_PORT_REG;else{if("address"!==x.type||"number"!=y.type)throw A+" does not support this operands";z=a.OUT_PORT_NUMBER}h.push(z,x.value,y.value);break;case"STOP":t("STOP",w[d]),z=a.STOP,h.push(z);break;default:throw"Invalid instruction: "+w[2]}}}else{var D=l[u].trim();if(""!==D&&";"!==D.slice(0,1))throw"Syntax error"}}catch(E){throw{error:E,line:u}}for(u=0,v=h.length;v>u;u++)if(!angular.isNumber(h[u])){if(!(h[u]in j))throw{error:"Undefined label: "+h[u]};h[u]=j[h[u]]}return{code:h,mapping:i,labels:j}}}}]),app.service("cpu",["opcodes","memory","io",function(a,b,c){var d={step:function(){var d=this;if(d.fault===!0)throw"FAULT. Reset to continue.";try{var e,f,g,h,i,j=function(a){if(0>a||a>=d.gpr.length)throw"Invalid register: "+a;return a},k=function(a){if(0>a||a>=1+d.gpr.length)throw"Invalid register: "+a;return a},l=function(a,b){if(a>=0&&a<d.gpr.length)d.gpr[a]=b;else{if(a!=d.gpr.length)throw"Invalid register: "+a;d.sp=b}},m=function(a){if(a>=0&&a<d.gpr.length)return d.gpr[a];if(a==d.gpr.length)return d.sp;throw"Invalid register: "+a},n=function(a){var b,c=a%8;b=c<d.gpr.length?d.gpr[c]:d.sp;var e=Math.floor(a/8);return e>15&&(e-=32),b+e},o=function(a){return d.zero=!1,d.carry=!1,a>=256?(d.carry=!0,a%=256):0>a&&(d.carry=!0,a=256- -a%256),0===a&&(d.zero=!0),a},p=function(a,b){if(0===b)return d.carry=!1,d.zero=!1,a;if(b>8)return d.carry=!1,d.zero=!1,0;var c=a<<b;return d.carry=0!==(256&c),c&=255,d.zero=0===c,c},q=function(a,b){if(0===b)return d.carry=!1,d.zero=!1,a;if(b>8)return d.carry=!1,d.zero=!1,0;var c=a>>b;return d.carry=0!==(a&1<<b-1),d.zero=0===c,c},r=function(a,b){if(0===b)return d.carry=!1,d.zero=!1,a;b%=8;var c=a<<b&255|a>>8-b;return d.carry=0!==(1&c),d.zero=0===c,c},s=function(a,b){if(0===b)return d.carry=!1,d.zero=!1,a;b%=8;var c=a>>b|a<<8-b&255;return d.carry=0!==(128&c),d.zero=0===c,c},t=function(a){d.ip=a},u=function(a){b.store(d.sp--,a)},v=function(){var a=b.load(++d.sp);return a},w=function(a){if(0===a)throw"Division by 0";return Math.floor(d.gpr[0]/a)},x=function(a){return(0>a||a>=256)&&(a=(a%256+256)%256),a},y=b.load(d.ip);switch(y){case a.NOP:d.ip++;break;case a.MOV_REG_TO_REG:e=k(b.load(++d.ip)),f=k(b.load(++d.ip)),l(e,m(f)),d.ip++;break;case a.MOV_ADDRESS_TO_REG:e=k(b.load(++d.ip)),g=b.load(++d.ip),l(e,b.load(g)),d.ip++;break;case a.MOV_REGADDRESS_TO_REG:e=k(b.load(++d.ip)),f=b.load(++d.ip),l(e,b.load(n(f))),d.ip++;break;case a.MOV_REG_TO_ADDRESS:h=b.load(++d.ip),f=k(b.load(++d.ip)),b.store(h,m(f)),d.ip++;break;case a.MOV_REG_TO_REGADDRESS:e=b.load(++d.ip),f=k(b.load(++d.ip)),b.store(n(e),m(f)),d.ip++;break;case a.MOV_NUMBER_TO_REG:e=k(b.load(++d.ip)),i=b.load(++d.ip),l(e,i),d.ip++;break;case a.MOV_NUMBER_TO_ADDRESS:h=b.load(++d.ip),i=b.load(++d.ip),b.store(h,i),d.ip++;break;case a.MOV_NUMBER_TO_REGADDRESS:e=b.load(++d.ip),i=b.load(++d.ip),b.store(n(e),i),d.ip++;break;case a.ADD_REG_TO_REG:e=k(b.load(++d.ip)),f=k(b.load(++d.ip)),l(e,o(m(e)+m(f))),d.ip++;break;case a.ADD_REGADDRESS_TO_REG:e=k(b.load(++d.ip)),f=b.load(++d.ip),l(e,o(m(e)+b.load(n(f)))),d.ip++;break;case a.ADD_ADDRESS_TO_REG:e=k(b.load(++d.ip)),g=b.load(++d.ip),l(e,o(m(e)+b.load(g))),d.ip++;break;case a.ADD_NUMBER_TO_REG:e=k(b.load(++d.ip)),i=b.load(++d.ip),l(e,o(m(e)+i)),d.ip++;break;case a.SUB_REG_FROM_REG:e=k(b.load(++d.ip)),f=k(b.load(++d.ip)),l(e,o(m(e)-d.gpr[f])),d.ip++;break;case a.SUB_REGADDRESS_FROM_REG:e=k(b.load(++d.ip)),f=b.load(++d.ip),l(e,o(m(e)-b.load(n(f)))),d.ip++;break;case a.SUB_ADDRESS_FROM_REG:e=k(b.load(++d.ip)),g=b.load(++d.ip),l(e,o(m(e)-b.load(g))),d.ip++;break;case a.SUB_NUMBER_FROM_REG:e=k(b.load(++d.ip)),i=b.load(++d.ip),l(e,o(m(e)-i)),d.ip++;break;case a.INC_REG:e=k(b.load(++d.ip)),l(e,o(m(e)+1)),d.ip++;break;case a.DEC_REG:e=k(b.load(++d.ip)),l(e,o(m(e)-1)),d.ip++;break;case a.CMP_REG_WITH_REG:e=k(b.load(++d.ip)),f=k(b.load(++d.ip)),o(m(e)-m(f)),d.ip++;break;case a.CMP_REGADDRESS_WITH_REG:e=k(b.load(++d.ip)),f=b.load(++d.ip),o(m(e)-b.load(n(f))),d.ip++;break;case a.CMP_ADDRESS_WITH_REG:e=k(b.load(++d.ip)),g=b.load(++d.ip),o(m(e)-b.load(g)),d.ip++;break;case a.CMP_NUMBER_WITH_REG:e=k(b.load(++d.ip)),i=b.load(++d.ip),o(m(e)-i),d.ip++;break;case a.JMP_REGADDRESS:e=j(b.load(++d.ip)),t(d.gpr[e]);break;case a.JMP_ADDRESS:i=b.load(++d.ip),t(i);break;case a.JC_REGADDRESS:e=j(b.load(++d.ip)),d.carry?t(d.gpr[e]):d.ip++;break;case a.JC_ADDRESS:i=b.load(++d.ip),d.carry?t(i):d.ip++;break;case a.JNC_REGADDRESS:e=j(b.load(++d.ip)),d.carry?d.ip++:t(d.gpr[e]);break;case a.JNC_ADDRESS:i=b.load(++d.ip),d.carry?d.ip++:t(i);break;case a.JZ_REGADDRESS:e=j(b.load(++d.ip)),d.zero?t(d.gpr[e]):d.ip++;break;case a.JZ_ADDRESS:i=b.load(++d.ip),d.zero?t(i):d.ip++;break;case a.JNZ_REGADDRESS:e=j(b.load(++d.ip)),d.zero?d.ip++:t(d.gpr[e]);break;case a.JNZ_ADDRESS:i=b.load(++d.ip),d.zero?d.ip++:t(i);break;case a.JA_REGADDRESS:e=j(b.load(++d.ip)),d.zero||d.carry?d.ip++:t(d.gpr[e]);break;case a.JA_ADDRESS:i=b.load(++d.ip),d.zero||d.carry?d.ip++:t(i);break;case a.JNA_REGADDRESS:e=j(b.load(++d.ip)),d.zero||d.carry?t(d.gpr[e]):d.ip++;break;case a.JNA_ADDRESS:i=b.load(++d.ip),d.zero||d.carry?t(i):d.ip++;break;case a.PUSH_REG:f=j(b.load(++d.ip)),u(d.gpr[f]),d.ip++;break;case a.PUSH_REGADDRESS:f=b.load(++d.ip),u(b.load(n(f))),d.ip++;break;case a.PUSH_ADDRESS:g=b.load(++d.ip),u(b.load(g)),d.ip++;break;case a.PUSH_NUMBER:i=b.load(++d.ip),u(i),d.ip++;break;case a.POP_REG:e=j(b.load(++d.ip)),d.gpr[e]=v(),d.ip++;break;case a.CALL_REGADDRESS:e=j(b.load(++d.ip)),u(d.ip+1),t(d.gpr[e]);break;case a.CALL_ADDRESS:i=b.load(++d.ip),u(d.ip+1),t(i);break;case a.RET:t(v());break;case a.MUL_REG:f=j(b.load(++d.ip)),d.gpr[0]=o(d.gpr[0]*d.gpr[f]),d.ip++;break;case a.MUL_REGADDRESS:f=b.load(++d.ip),d.gpr[0]=o(d.gpr[0]*b.load(n(f))),d.ip++;break;case a.MUL_ADDRESS:g=b.load(++d.ip),d.gpr[0]=o(d.gpr[0]*b.load(g)),d.ip++;break;case a.MUL_NUMBER:i=b.load(++d.ip),d.gpr[0]=o(d.gpr[0]*i),d.ip++;break;case a.DIV_REG:f=j(b.load(++d.ip)),d.gpr[0]=o(w(d.gpr[f])),d.ip++;break;case a.DIV_REGADDRESS:f=b.load(++d.ip),d.gpr[0]=o(w(b.load(n(f)))),d.ip++;break;case a.DIV_ADDRESS:g=b.load(++d.ip),d.gpr[0]=o(w(b.load(g))),d.ip++;break;case a.DIV_NUMBER:i=b.load(++d.ip),d.gpr[0]=o(w(i)),d.ip++;break;case a.AND_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=o(d.gpr[e]&d.gpr[f]),d.ip++;break;case a.AND_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]&b.load(n(f))),d.ip++;break;case a.AND_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]&b.load(g)),d.ip++;break;case a.AND_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]&i),d.ip++;break;case a.OR_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=o(d.gpr[e]|d.gpr[f]),d.ip++;break;case a.OR_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]|b.load(n(f))),d.ip++;break;case a.OR_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]|b.load(g)),d.ip++;break;case a.OR_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]|i),d.ip++;break;case a.XOR_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=o(d.gpr[e]^d.gpr[f]),d.ip++;break;case a.XOR_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]^b.load(n(f))),d.ip++;break;case a.XOR_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]^b.load(g)),d.ip++;break;case a.XOR_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=o(d.gpr[e]^i),d.ip++;break;case a.NOT_REG:e=j(b.load(++d.ip)),d.gpr[e]=o(~d.gpr[e]),d.ip++;break;case a.SHL_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=p(d.gpr[e],d.gpr[f]),d.ip++;break;case a.SHL_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=p(d.gpr[e],b.load(n(f))),d.ip++;break;case a.SHL_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=p(d.gpr[e],b.load(g)),d.ip++;break;case a.SHL_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=p(d.gpr[e],i),d.ip++;break;case a.SHR_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=q(d.gpr[e],d.gpr[f]),d.ip++;break;case a.SHR_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=q(d.gpr[e],b.load(n(f))),d.ip++;break;case a.SHR_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=q(d.gpr[e],b.load(g)),d.ip++;break;case a.SHR_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=q(d.gpr[e],i),d.ip++;break;case a.ROL_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=r(d.gpr[e],d.gpr[f]),d.ip++;break;case a.ROL_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=r(d.gpr[e],b.load(n(f))),d.ip++;break;case a.ROL_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=r(d.gpr[e],b.load(g)),d.ip++;break;case a.ROL_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=r(d.gpr[e],i),d.ip++;break;case a.ROR_REG_WITH_REG:e=j(b.load(++d.ip)),f=j(b.load(++d.ip)),d.gpr[e]=s(d.gpr[e],d.gpr[f]),d.ip++;break;case a.ROR_REGADDRESS_WITH_REG:e=j(b.load(++d.ip)),f=b.load(++d.ip),d.gpr[e]=s(d.gpr[e],b.load(n(f))),d.ip++;break;case a.ROR_ADDRESS_WITH_REG:e=j(b.load(++d.ip)),g=b.load(++d.ip),d.gpr[e]=s(d.gpr[e],b.load(g)),d.ip++;break;case a.ROR_NUMBER_WITH_REG:e=j(b.load(++d.ip)),i=b.load(++d.ip),d.gpr[e]=s(d.gpr[e],i),d.ip++;break;case a.RND_REG:e=k(b.load(++d.ip)),l(e,Math.floor(256*Math.random())),d.ip++;break;case a.IN_REG_PORT:e=k(b.load(++d.ip)),portFrom=b.load(++d.ip),l(e,c.read_from_port(portFrom)),d.ip++;break;case a.OUT_PORT_REG:portTo=b.load(++d.ip),f=j(b.load(++d.ip)),c.write_to_port(portTo,d.gpr[f]),d.ip++;break;case a.OUT_PORT_NUMBER:portTo=b.load(++d.ip),value=b.load(++d.ip),c.write_to_port(portTo,value),d.ip++;break;case a.STOP:return d.ip++,!1;case a.HALT:return!1;default:throw"Invalid op code: "+y}return d.ip=x(d.ip),d.sp=x(d.sp),d.gpr[0]=x(d.gpr[0]),d.gpr[1]=x(d.gpr[1]),d.gpr[2]=x(d.gpr[2]),d.gpr[3]=x(d.gpr[3]),!0}catch(z){throw d.fault=!0,z}},reset:function(){var a=this;a.maxSP=239,a.minSP=0,a.gpr=[0,0,0,0],a.sp=a.maxSP,a.ip=0,a.zero=!1,a.carry=!1,a.fault=!1,c.reset()},isHalted:function(){return b.load(this.ip)==a.HALT}};return d.reset(),d}]),app.service("io",[function(){var a=0,b=0;document.addEventListener("keypress",function(b){var c=b.charCode||0;a=c}),document.addEventListener("keydown",function(a){switch(a.key){case"Escape":b|=128;break;case"Shift":b|=64;break;case"Control":b|=32;break;case"Backspace":b|=16;break;case"ArrowUp":b|=8;break;case"ArrowDown":b|=4;break;case"ArrowLeft":b|=2;break;case"ArrowRight":b|=1}});var c={reset:function(){a=0,b=0},read_from_port:function(c){switch(c){case 0:return a;case 1:return b;default:return 0}},write_to_port:function(c,d){switch(c){case 0:a=d;break;case 1:b=d}}};return c}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;return(0>a||a>=b.data.length)&&(a=(a%256+256)%256),b.lastAccess=a,b.data[a]},store:function(a,b){var c=this;(0>a||a>=c.data.length)&&(a=(a%256+256)%256),c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={NOP:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97,ROL_REG_WITH_REG:98,ROL_REGADDRESS_WITH_REG:99,ROL_ADDRESS_WITH_REG:100,ROL_NUMBER_WITH_REG:101,ROR_REG_WITH_REG:102,ROR_REGADDRESS_WITH_REG:103,ROR_ADDRESS_WITH_REG:104,ROR_NUMBER_WITH_REG:105,RND_REG:106,IN_REG_PORT:107,OUT_PORT_REG:108,OUT_PORT_NUMBER:109,STOP:254,HALT:255};return a}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e,f){function g(){return!b.isRunning}b.memory=e,b.cpu=d,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!1,b.displayA=!1,b.displayB=!1,b.displayC=!1,b.displayD=!1,b.speeds=[{speed:1,desc:"1 Hz"},{speed:2,desc:"2 Hz"},{speed:5,desc:"5 Hz"},{speed:10,desc:"10 Hz"},{speed:50,desc:"50 Hz"},{speed:100,desc:"100 Hz"},{speed:1/0,desc:"Turbo"}],b.speed=10,b.outputStartIndex=240,b.bitmapMode=!1,b.codeSize=0,b.minimalDisplay=!1,b.code="",b.reset=function(){d.reset(),e.reset(),b.stop(),b.error="",b.selectedLine=-1,b.mapping={},b.labels={},b.codeSize=0},b.executeStep=function(){try{var a=d.step();return g()&&d.ip in b.mapping&&(b.selectedLine=b.mapping[d.ip]),a}catch(c){return console.error(c),b.error=c,!1}},b.startRun=function(){b.cpu.isHalted()&&b.assemble(),b.run()};var h;b.run=function(){b.isRunning=!0,h=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(h),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=e.data.length;b>a;a++)if(0!==e.data[a])return!0;return!1},b.changeVideoMode=function(){b.bitmapMode=!b.bitmapMode},b.curVideoMode=function(){return b.bitmapMode?"Dot-Matrix":"Character"},b.getCharClass=function(a){return 128>a?"output-normal":"output-inverted"},b.getChar=function(a){var b,c=" ░▒▓█▀▄◼◻●○◀▶▼▲▪";return a>=128&&(a-=128),b=a>=32?String.fromCharCode(a):c[a]||"",""===b.trim()?"  ":b},b.getCharBitmap=function(a,b){var c=0!==(a&1<<b);return c?"on":"off"},b.assemble=function(){try{b.reset();var a=f.go(b.code);b.mapping=a.mapping;var c=a.code;if(b.labels=a.labels,c.length>e.data.length)throw"Binary code does not fit into the memory. Max "+e.data.length+" bytes are allowed";for(var d=0,g=c.length;g>d;d++)e.data[d]=c[d];b.codeSize=c.length}catch(h){void 0!==h.line?(b.error=h.line+" | "+h.error,b.selectedLine=h.line):b.error=h.error}},b.jumpToLine=function(c){g()&&(a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c])},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return a>=b.outputStartIndex?"output-bg":b.isInstruction(a)?"instr-bg":a<b.codeSize?"code-bg":a>d.sp&&a<=d.maxSP?"stack-bg":""},b.getMemoryInnerCellCss=function(a){return a===d.ip?"marker marker-ip":a===d.sp?"marker marker-sp":a===d.gpr[0]&&b.displayA?"marker marker-a":a===d.gpr[1]&&b.displayB?"marker marker-b":a===d.gpr[2]&&b.displayC?"marker marker-c":a===d.gpr[3]&&b.displayD?"marker marker-d":""},b.toggleMinimalDisplay=function(){b.minimalDisplay=!b.minimalDisplay}}]),app.filter("flag",function(){return function(a){return a?"1":"0"}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);